## 一、PostgreSQL 之索引

### 1、简介

- 索引会加快查询速度
- 系统会在修改表时更新索引，并判断使用索引比顺序表扫描更有效时，使用索引
    - 您可能需要**定期运行 ANALYZE 命令**来更新统计信息，以允许**查询计划器**做出明智的决策
- 使**带有搜索条件**的 UPDATE 和 DELETE 命令受益
- 索引可用于**连接搜索**
- 在大型表上创建索引可能需要很长时间
- 默认情况下，pgsql 中创建索引时表可读，但不可写入（INSERT、UPDATE、DELETE）。在生产环境中，可以通过配置**并行构建索引**支持写入。
- 索引会阻止创建**仅堆元组**

### 2、索引类型

PostgreSQL 提供了几种索引类型：B-树（默认，适合大部分情况）、哈希、GiST、SP-GiST、GIN、BRIN 以及扩展 bloom。

通过编写关键字 USING 后跟索引类型名称来选择其它索引，例如 哈希索引：

```sql
CREATE INDEX name ON table USING HASH (column);
```

#### 2.1 B- 树

适用如下场景：

- 可**排序**为某种顺序的数据上的**等值**和**范围查询**
- <   <= =   >=   >，包括等效于这些操作符的结构，比如 BETWEEN 和 IN。此外，也包括索引列上的 IS NULL 或 IS NOT NULL 条件
- 模式匹配运算符 LIKE 和 ~（正则匹配） 的查询（模式是常量并且锚定到字符串的开头）
    - 比如：`col LIKE 'foo%'` 或 `col ~ '^foo'`，但不是 `col LIKE '%bar'`。
- 也可以对 ILIKE 和 ~* 使用 B-树索引，但前提是模式**以非字母字符开头**，即**不受大小写转换影响**的字符。
- B- 树索引也可用于**按排序顺序检索数据**

#### 2.2 哈希索引

哈希索引存储从索引列的值派生的 32 位哈希代码。适用于**等值查询**。

#### 2.3 GiST 索引

GiST 索引不是单一类型的索引，而是在其中可以实现**许多不同索引策略的基础设施**。

GiST 代表**广义搜索树**。它是一种**平衡的**树形结构访问方法，充当实现任意索引方案的基本模板。B 树、R 树以及许多其他索引方案都可以在 GiST。

GiST 的一个优点是 GiST 它允许**领域专家**为**自定义数据类型**开发**相应的访问方法**，而不是数据库专家。

可以使用 GiST 索引的特定运算符会根据索引策略（运算符类）而有所不同。

#### 2.4 SP-GiST

SP-GiST 索引与 GiST 索引一样，提供了一个**支持各种类型搜索**的**基础设施**。

SP-GiST 是空间分区的缩写 GiST. SP-GiST 支持**分区搜索树**，尽可能简化各种不同的**非平衡数据结构**的开发工作，例如四叉树、k-d 树和基数树（字典树）。
这些结构共同的特点是，它们会不断地将**搜索空间**分割成**不必相等**的**若干个分区**。**与分区规则匹配得相当的搜索，通常可以很快得到结果**。

这些流行的数据结构起初是**为内存内使用而开发**的。在主内存中，它们通常被设计为一组动态分配的节点，这些节点由指针链接起来。
这并不适合直接存储在磁盘上，因为这些指针链可能相当长，因而需要太多的磁盘访问操作。
相比之下，基于磁盘的数据结构应具有较高的扇出率，以最大程度地减少 I/O 次数。
**SP-GiST 将搜索树节点映射到磁盘页面，即使遍历了许多节点，搜索也只需访问几个磁盘页面。**

比如 GiST, SP-GiST 旨在允许一个数据类型（这里的数据类型，指的应该就是后文提到的自定义数据类型）方面的专家（而不是数据库专家）开发**具有适当访问方法的自定义数据类型**。

#### 2.5 GIN（倒排索引）

适用于**包含多个组件值的数据值**，例如数组。倒排索引为每个组件值包含一个单独的条目，并且可以有效地处理**测试特定组件值的存在**的查询。

GIN 可以支持许多不同的**用户定义索引策略**，并且可以使用 GIN 索引的特定运算符会根据索引策略而有所不同。

#### 2.6 BRIN（块范围索引）

存储有关**表连续物理块范围内存储的值的摘要**。因此，它们对于**其值与表行的物理顺序高度相关的列**最有效。


> pg 的官方文档太难看了，难以理解，不看了