## 一、和客户端打交道

## 1、Redis 二进制协议

> [Redis二进制协议](https://ls8sck0zrg.feishu.cn/wiki/wikcnbh8oUNZNgH8Q7fGahqQ7vd "Redis二进制协议")
> 

## 2、pipeline 

### 2.1 客户端与服务端交互

客户端发送请求，服务端接收请求并处理，最后返回包。假设我们要做多次操作，那实际执行会是这样：

```text
127.0.0.1:6379> SET num 1
OK
127.0.0.1:6379> INCR num
(integer) 2
127.0.0.1:6379> GET num
"2"
```

可以看到，这种客户端服务器交互模式下，我们需要一条命令结束了，再执行另一个命令，也就是说，多客户端可以并发，
但是单客户端是同步的，而一次请求的时间，其实不光受 Redis 本身处理性能影响，**很大程度还会受网络波动影响**，
在客户端大量发包场景，很可能会因为波动造成性能瓶颈。

![img.png](pictures/4）2.1-1.png)

所以，有没有一种技术，能够让客户端可以将多条命令一起传递给服务端？

### 2.2 Pipeline 技术

Pipeline，即管道技术，顾名思义，是将请求打包在一起，通过管道传递。Pipeline 是很成熟的技术，
在很多其它组件中也有出现，比如 HTTP2.0，比如 ETCD，以及很多 POP3 协议。

![img.png](pictures/4）2.2-1.png)

Pipeline 的本质，是将请求在客户端打包，然后一次发送给服务端，服务端处理完成之后，会将结果存起来，
等 Pipeline 中所有命令都完成了，再一起回包，**这样可以节约很多网络交互的时间**。

#### 2.2.1 Pipeline 的代价

Pipeline 可以让多个请求一起打包发给服务端，这样看起来，请求都走 Pipeline 模式是一个好的选择？实际不是的，任何方案都不可能只有优点、没有缺点。Pipeline 也是付出“代价”的：
1. 当使用 Pipeline，服务端不得不为回包排队，**同一时间会占用更多内存**，我们一直有说，Redis 内存是寸土寸金，**所以除非特定场景，不然也没必要强行使用 Pipeline**。
2. **单个命令的时间会变长**，原因是需要等待 Pipeline 中其它命令的完成。

#### 2.2.2 Pipeline 注意事项

1. **Pipeline 的命令不是原子的**，因为实际上 Redis 还是一条一条去执行；
   - 如果在前后包一个 multi exec，就可以原子性了
2. **Pipeline 包含的命令也不宜过多**，Redis 内存寸土寸金；
3. **Pipeline 只会在一个 Redis 节点上执行**，这个很好了解，因为其实客户端是发送了一次请求，并不会分发到多个节点上。

#### 2.2.3 适用场景

适用于一个流程中多次操作 Redis 的场景，比如一个线程需要更新 100 个学生的分数，这时候可以用 Pipeline 打包执行。











